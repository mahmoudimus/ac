<div class="ap-container" id="ap-$namespace">
  $!extraMarkupHtml
  <div class="ap-content" id="embedded-$namespace"></div>
  <div class="ap-stats hidden">
    <div class="ap-loading ap-status">
      Loading plugin <a href="${plugin.displayUrl}" target="_blank">$plugin.name</a>.
    </div>
    <div class="ap-loaded ap-status hidden">
      Loaded plugin <a href="${plugin.displayUrl}" target="_blank">$plugin.name</a>.
    </div>
    <div class="ap-load-timeout ap-status hidden">
      Plugin <a href="${plugin.displayUrl}" target="_blank">$plugin.name</a> is not responding.
      <a href="#" class="ap-btn-wait">Wait</a> or <a href="#" class="ap-btn-cancel">Cancel</a>?
    </div>
    <div class="ap-load-error ap-status hidden">
      Plugin <a href="${plugin.displayUrl}" target="_blank">$plugin.name</a> failed to load.
    </div>
  </div>
  ## @todo optimize script delivery
  #foreach ($scriptUrl in $scriptUrls)
    <script src="$scriptUrl"></script>
  #end
  <script>
    (function(jQuery, JIRA) {
        function init() {
          _AP.create({
            ns: "$namespace",
            src: "$iframeSrcHtml",
            width: "$!width",
            height: "$!height",
            contextPath: "$contextPath",
            appKey: "$plugin.key",
            userId: "$userId",
            dialog: "$!dialog",
            data: {
                #foreach($e in $data.entrySet())
                    "${e.key}": "${e.value}"#if(!${foreach.isLast()}),#end
                #end
            }
          });
        }
        if (JIRA) {
            jQuery(function() {
                JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED, function(e, context, reason) {
                    var jcontext = jQuery(context);
                    var initializedIFrame = jQuery('#ap-$namespace', jcontext);
                    if (initializedIFrame.length > 0) {
                        jQuery('#embedded-$namespace').empty();
                        init();
                    }
                });
            });
        }
        init();
    })(jQuery, window.JIRA);

  </script>
</div>
